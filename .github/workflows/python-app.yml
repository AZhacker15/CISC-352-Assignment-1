name: Autograder

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  grade:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: "A1 Files"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (if requirements.txt exists)
        run: |
          python -V
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f ../requirements.txt ]; then
            pip install -r ../requirements.txt
          fi

      # 跑 autograder，并把 stdout/stderr 同时保存
      # 注意：autograder 可能会返回非 0（因为有 FAIL），我们仍然要继续后面的步骤保存 results.txt
      - name: Run autograder (always continue)
        run: |
          set +e
          python autograder_stu.py 2>&1 | tee run_stdout.txt
          echo "AUTOGRADER_EXIT_CODE=$?" >> "$GITHUB_ENV"

      - name: Verify results.txt exists
        run: |
          ls -l results.txt
          test -s results.txt

      # 上传产物：results.txt + 运行日志
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autograder-artifacts
          retention-days: 7
          path: |
            A1 Files/results.txt
            A1 Files/run_stdout.txt

      # 最后根据 autograder 的退出码决定 job 是否失败（可选）
      # 如果你希望：即使有 FAIL 也不要让 Actions 红掉，可以把这个步骤删除或永远 exit 0
      - name: Fail job if autograder returned non-zero
        run: |
          code="${AUTOGRADER_EXIT_CODE:-0}"
          echo "autograder exit code: $code"
          exit "$code"
