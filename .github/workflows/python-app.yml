name: Autograder

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  grade:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash
        working-directory: "A1 Files"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (if requirements.txt exists)
        run: |
          python -V
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f ../requirements.txt ]; then
            pip install -r ../requirements.txt
          fi

      - name: Run autograder (always continue)
        run: |
          set +e
          python autograder_stu.py 2>&1 | tee run_stdout.txt
          echo "AUTOGRADER_EXIT_CODE=$?" >> "$GITHUB_ENV"

      - name: Verify results.txt exists
        run: |
          ls -l results.txt
          test -s results.txt

      - name: Extract FAIL/ERROR from results.txt
        run: |
          fail_count=$(grep -cE ' ... FAIL$' results.txt || true)
          err_count=$(grep -cE ' ... ERROR$' results.txt || true)

          echo "FAIL_COUNT=$fail_count" >> "$GITHUB_ENV"
          echo "ERROR_COUNT=$err_count" >> "$GITHUB_ENV"

          echo "FAIL count:  $fail_count"
          echo "ERROR count: $err_count"

          grep -E ' ... (FAIL|ERROR)$' results.txt \
            | sed -E 's/ \.\.\. (FAIL|ERROR)$//' \
            > fail_list.txt || true

          grep -E ' ... (FAIL|ERROR)$' results.txt > fail_raw_lines.txt || true

          {
            echo "FAIL count:  $fail_count"
            echo "ERROR count: $err_count"
            echo ""
            echo "---- FAIL/ERROR tests ----"
            cat fail_list.txt
          } > fail_summary.txt

          echo "---- fail_summary.txt ----"
          cat fail_summary.txt

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autograder-artifacts
          retention-days: 7
          path: |
            A1 Files/results.txt
            A1 Files/run_stdout.txt
            A1 Files/fail_summary.txt
            A1 Files/fail_list.txt
            A1 Files/fail_raw_lines.txt

      # ✅ 只要 results.txt 里有任何 FAIL/ERROR，就让 job 失败
      - name: Fail if any FAIL/ERROR in results.txt
        run: |
          echo "FAIL_COUNT=${FAIL_COUNT:-0}, ERROR_COUNT=${ERROR_COUNT:-0}"
          if [ "${FAIL_COUNT:-0}" -gt 0 ] || [ "${ERROR_COUNT:-0}" -gt 0 ]; then
            echo "Found FAIL/ERROR in results.txt. Failing the job."
            exit 1
          fi
          echo "No FAIL/ERROR found."

      # （可选）如果你还想同时要求 autograder 退出码也必须是 0，就保留这一段
      # 否则你可以删除它，因为上面已经保证“有 FAIL/ERROR 就失败”了
      - name: Fail job if autograder returned non-zero (optional)
        run: |
          code="${AUTOGRADER_EXIT_CODE:-0}"
          echo "autograder exit code: $code"
          exit "$code"
